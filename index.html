<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Effet Miroir - Party</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #6366f1; --secondary: #10b981; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #cbd5e1; }
        .player-item { background: white; border: 2px solid var(--primary); margin: 10px 0; padding: 15px; border-radius: 10px; cursor: grab; font-weight: bold; display: flex; justify-content: space-between; }
        .hidden { display: none; }
        #room-id-display { background: #e0e7ff; padding: 10px; border-radius: 5px; font-weight: bold; color: var(--primary); margin: 10px 0; }
    </style>
</head>
<body>

    <div id="view-home" class="card">
        <h1>ðŸªž L'Effet Miroir</h1>
        <button onclick="showCreateRoom()">CrÃ©er une partie privÃ©e</button>
        <button onclick="showJoinRoom()" style="background:#64748b">Rejoindre avec un code</button>
        <hr>
        <h3>ðŸ“¥ Banque publique</h3>
        <p style="font-size: 0.9em; color: #666;">Ajoute une question pour tout le monde :</p>
        <input type="text" id="public-q" placeholder="Qui est le plus... ?">
        <button onclick="addPublicQuestion()" style="background: var(--secondary)">Ajouter Ã  la banque</button>
    </div>

    <div id="view-lobby" class="card hidden">
        <h2>Salon : <span id="display-room-id"></span></h2>
        <p>Partage ce code Ã  tes amis !</p>
        <div id="player-list">Attente de joueurs...</div>
        <div id="admin-controls" class="hidden">
            <button onclick="startGame()" style="background: var(--secondary); margin-top: 20px;">DÃ‰MARRER LE JEU</button>
        </div>
    </div>

    <div id="view-game" class="card hidden">
        <h2 id="current-q">Chargement...</h2>
        <div id="sort-list"></div>
        <button id="btn-vote" onclick="submitVote()">Valider mon classement</button>
        <p id="wait-msg" class="hidden">Attente des autres joueurs...</p>
    </div>

    <script>
        // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBZrjaZ0NuoQkm2i8ZrBZEDm0iFNQ_xwRg",
        databaseURL: "https://jeux-classement-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "jeux-classement",

        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomId = "";
        let myName = "";
        let isAdmin = false;
        let players = [];

        // --- NAVIGATION ---
        function showCreateRoom() {
            myName = prompt("Ton prÃ©nom ?");
            if(!myName) return;
            roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            isAdmin = true;
            initRoom();
        }

        function showJoinRoom() {
            const code = prompt("Code de la partie ?");
            if(!code) return;
            myName = prompt("Ton prÃ©nom ?");
            if(!myName) return;
            roomId = code.toUpperCase();
            initRoom();
        }

        function initRoom() {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-lobby').classList.remove('hidden');
            document.getElementById('display-room-id').innerText = roomId;
            
            if(isAdmin) document.getElementById('admin-controls').classList.remove('hidden');

            // S'ajouter Ã  la liste des joueurs
            db.ref(`rooms/${roomId}/players`).push(myName);

            // Ã‰couter les joueurs
            db.ref(`rooms/${roomId}/players`).on('value', snap => {
                players = Object.values(snap.val() || {});
                document.getElementById('player-list').innerHTML = "<b>Joueurs :</b><br>" + players.join(', ');
            });

            // Ã‰couter le lancement du jeu
            db.ref(`rooms/${roomId}/status`).on('value', snap => {
                if(snap.val() === "playing") startClientGame();
            });
        }

        // --- BANQUE PUBLIQUE ---
        function addPublicQuestion() {
            const q = document.getElementById('public-q').value;
            if(q) {
                db.ref('public_bank').push(q);
                alert("Merci ! Question ajoutÃ©e.");
                document.getElementById('public-q').value = "";
            }
        }

        // --- LOGIQUE DE JEU ---
        function startGame() {
            // Piocher une question au hasard dans la banque publique
            db.ref('public_bank').once('value', snap => {
                const questions = Object.values(snap.val() || { "0": "Qui est le plus drÃ´le ?" });
                const randomQ = questions[Math.floor(Math.random() * questions.length)];
                
                db.ref(`rooms/${roomId}`).update({
                    status: "playing",
                    currentQuestion: randomQ,
                    votes: null
                });
            });
        }

        function startClientGame() {
            document.getElementById('view-lobby').classList.add('hidden');
            document.getElementById('view-game').classList.remove('hidden');
            
            db.ref(`rooms/${roomId}/currentQuestion`).on('value', snap => {
                document.getElementById('current-q').innerText = snap.val();
                renderSortable();
                document.getElementById('btn-vote').classList.remove('hidden');
                document.getElementById('wait-msg').classList.add('hidden');
            });
        }

        function renderSortable() {
            const list = document.getElementById('sort-list');
            list.innerHTML = "";
            players.filter(p => p !== myName).forEach(p => {
                list.innerHTML += `<div class="player-item" data-name="${p}">${p} <span>â˜°</span></div>`;
            });
            new Sortable(list, { animation: 150 });
        }

        function submitVote() {
            const items = document.querySelectorAll('.player-item');
            const ranking = Array.from(items).map(i => i.getAttribute('data-name'));
            db.ref(`rooms/${roomId}/votes/${myName}`).set(ranking);
            
            document.getElementById('btn-vote').classList.add('hidden');
            document.getElementById('wait-msg').classList.remove('hidden');
        }
    </script>
</body>
</html>
